# Description

Repository where we store reusable terraform modules for GDS Entra.

## Requirements

* [checkov](https://www.checkov.io/)
* [codespell](https://github.com/codespell-project/codespell)
* [pre-commit](https://pre-commit.com/)
* [terraform-docs](https://github.com/terraform-docs/terraform-docs)
* [tflint](https://github.com/terraform-linters/tflint)
* [trivy](https://github.com/aquasecurity/trivy)

Steps:
1. Install using `brew`:
  `brew install pre-commit tflint checkov trivy terraform-docs`

1. Install pre-commit hooks:
  `precommit install`

## Creating new modules

All terraform modules live in the root of the repository.

Create a new folder for your terraform module, using the following naming convention:
`<resource_type>-<module_name>`.

Please update the following filters when introducing a new module directory:

```hcl
# .pre-commit-config.yaml

      - id: terraform_docs
        files: ^(azurerm-conditional-access|msgraph-entra-domain)/.*\.tf$
        args:
          - --hook-config=--add-to-existing-output-files=true
          - --hook-config=--output-mode=inject
          - --hook-config=--config=.terraform-docs.yml
```

```hcl
# .github/workflows/terraform.yml

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            azurerm-conditional-access:
              - 'azurerm-conditional-access/**'
            msgraph-entra-domain:
              - 'msgraph-entra-domain/**'
```

## Generating documentation for the modules

A `README.md` file must be created on each module directory.
The file is divided in two parts:
* Static sections explaining what the module does, examples on how to use it and any caveats
* Auto-generated sections managed by `terraform-docs`.

Run `make docs-modules`. This will create a new file with the auto-generated sections. Add your content above the `<!-- BEGIN_TF_DOCS -->` line.

Every time a change is made to the terraform module, the documentation must be autogenerated again, by running the same command above.

## Releasing modules

First determine the next version to [release](https://github.com/alphagov/gds-engineering-access-terraform-modules/releases)

To release a new version of a specific module, create and push a git tag matching the module's directory name and desired version. For example, to release version 0.0.1 of the `azurerm-conditional-access` module, you would run the commands below from the root of the checked out repository:

```sh
git tag azurerm-conditional-access/v0.0.1 -m 'Initial release'
git push origin azurerm-conditional-access/v0.0.1
```

This will trigger the release workflow for that module only. Each module should be tagged and released independently using this pattern.

## Consuming modules

1. On the [Releases page](https://github.com/alphagov/gds-engineering-access-terraform-modules/releases), find your desired module/version combination and click on the short commit SHA hash:

![assets](./docs/assets.png)

2. On the commit page, click the copy button to retrieve the full commit SHA hash:

![assets](./docs/sha.png)

3. Reference the module in the source argument of your module block. Add a comment to indicate the release version this commit SHA represents:

```hcl
module "azurerm-conditional-access" {
  source = "github.com/alphagov/gds-engineering-access-terraform-modules//<module name>?depth=1?ref=<commit sha hash>" # <release version>
  #...
}
```

```hcl
# Example

module "azurerm-conditional-access" {
  source = "github.com/alphagov/gds-engineering-access-terraform-modules//azurerm-conditional-access?depth=1?ref=303d8966acf114429f8613fa070a1848c2ff3661" # v0.0.1
  #...
}
```

> [!NOTE]
> The double forward slash is required syntax when referencing a module in a repository subdirectory.
