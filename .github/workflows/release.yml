---
name: Release

on:
  push:
    tags:
      - "*/v*"  # Matches tags like terraform-azurerm-conditional-access/v1.0.0

permissions:
  contents: write

jobs:
  extract-module:
    name: Extract Module Info
    runs-on: ubuntu-latest
    outputs:
      module-name: ${{ steps.extract.outputs.module }}
      version: ${{ steps.extract.outputs.version }}
      zip-file: ${{ steps.zip.outputs.zip-file }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Extract module and version from tag
        id: extract
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          MODULE="${TAG%/v*}"
          VERSION="${TAG#*/}"
          echo "module=${MODULE}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Module: ${MODULE}, Version: ${VERSION}"

      # Zips up the module to be picked up by the next job (softprops/action-gh-release action in the reusable workflow).
      - name: Zip module directory
        shell: pwsh
        id: zip
        run: |
          $compress = @{
            Path = '${{ steps.extract.outputs.module }}'
            DestinationPath = '${{ steps.extract.outputs.module }}.zip'
            Passthru = $true
          }
          $zipFilePath = Compress-Archive @compress |
          Select-Object -ExpandProperty FullName

          Write-Output -InputObject "setting output zip-file=$zipFilePath"
          Write-Output -InputObject "zip-file=$zipFilePath" |
          Out-File -FilePath $env:GITHUB_OUTPUT -Append

  release:
    uses: alphagov/gds-github-workflows/.github/workflows/terraform-module-release.yml@add-working-directory-param
    name: GitHub Release
    needs: extract-module
    with:
      module-name: ${{ needs.extract-module.outputs.module-name }}
      version: ${{ needs.extract-module.outputs.version }}
      enable-cliff: false
      files: ${{ needs.extract-module.outputs.zip-file }}
