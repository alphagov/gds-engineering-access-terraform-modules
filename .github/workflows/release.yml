---
name: Release

on:
  push:
    tags:
      - "*/v*"  # Matches tags like terraform-azurerm-conditional-access/v1.0.0

permissions:
  contents: write

jobs:
  extract-module:
    name: Extract Module Info
    runs-on: ubuntu-latest
    outputs:
      module-name: ${{ steps.extract.outputs.module }}
      version: ${{ steps.extract.outputs.version }}
      zip-file: ${{ steps.zip.outputs.zip-file }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Extract module and version from tag
        id: extract
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          MODULE="${TAG%/v*}"
          VERSION="${TAG#*/}"
          echo "module=${MODULE}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Module: ${MODULE}, Version: ${VERSION}"

      # Zips up the module to be picked up by the next job (softprops/action-gh-release action in the reusable workflow).
      - name: Zip module directory
        id: zip
        run: |
          echo "pwd: $(pwd)"
          ls -a
          MODULE_DIR="${{ steps.extract.outputs.module }}"
          ZIP_FILE="${MODULE_DIR}.zip"
          cd "${MODULE_DIR}" || exit 1
          zip -r "${ZIP_FILE}" .
          echo "zip-file=${MODULE_DIR}/${ZIP_FILE}" >> "$GITHUB_OUTPUT"

  release:
    uses: alphagov/gds-github-workflows/.github/workflows/terraform-module-release.yml@add-working-directory-param
    name: GitHub Release
    needs: extract-module
    with:
      module-name: ${{ needs.extract-module.outputs.module-name }}
      version: ${{ needs.extract-module.outputs.version }}
      enable-cliff: false
      working-directory: ${{ needs.extract-module.outputs.module-name }}
      files: ${{ needs.extract-module.outputs.zip-file }}
